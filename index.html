<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üè≠ LƒÉng K√≠nh Ng∆∞·ªùi Ti√™u D√πng</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
body { font-family:'Roboto', sans-serif; background:#fff8dc; text-align:center; padding:20px;}
h1 { color:#6d28d9; }
button { padding:10px 20px; margin:5px; cursor:pointer; }
#game-container, #ranking-wrapper { display:none; margin-top:20px;}
table { width:100%; border-collapse: collapse; margin-top:10px;}
th, td { border:1px solid #ccc; padding:8px;}
.highlight { background:#fde047;}
#biscuitImage { max-width:300px; height:auto; margin-bottom:15px;}
#errorSection { margin-top:10px;}
#timer, #score { margin-top:10px; font-weight:bold;}
</style>
</head>
<body>

<h1>üè≠ LƒÉng K√≠nh Ng∆∞·ªùi Ti√™u D√πng</h1>

<div id="menu">
  <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..."><br>
  <button onclick="startGame('sanpham')"><i class="fas fa-cookie-bite"></i> S·∫£n ph·∫©m</button>
  <button onclick="startGame('baobi1')"><i class="fas fa-box"></i> Bao b√¨ c·∫•p 1</button>
  <button onclick="startGame('baobi2')"><i class="fas fa-boxes"></i> Bao b√¨ c·∫•p 2</button>
</div>

<div id="game-container">
  <div id="timer">Th·ªùi gian: 20s</div>
  <img id="biscuitImage" src="" alt="·∫¢nh l·ªói QC">
  <div>
    <button onclick="checkAnswer(true)"><i class="fas fa-check-circle"></i> ƒê·∫°t</button>
    <button onclick="checkAnswer(false)"><i class="fas fa-times-circle"></i> L·ªói</button>
  </div>

  <div id="errorSection" style="display:none;">
    <select id="errorSelect"></select>
    <button onclick="submitError()"><i class="fas fa-check"></i> X√°c nh·∫≠n l·ªói</button>
  </div>

  <div id="result"></div>
  <div id="score">ƒêi·ªÉm: 0</div>
  <button onclick="nextImage()"><i class="fas fa-arrow-right"></i> ·∫¢nh ti·∫øp theo</button>
</div>

<div id="ranking-wrapper">
  <h2>üéâ Ho√†n th√†nh!</h2>
  <p id="finalScoreText"></p>
  <label>L·ªçc: 
    <select id="rankingFilter" onchange="filterRanking()">
      <option value="">T·∫•t c·∫£</option>
      <option value="sanpham">S·∫£n ph·∫©m</option>
      <option value="baobi1">Bao b√¨ c·∫•p 1</option>
      <option value="baobi2">Bao b√¨ c·∫•p 2</option>
    </select>
  </label>
  <table id="rankingTable"></table>
  <button onclick="location.reload()"><i class="fas fa-redo"></i> Ch∆°i l·∫°i</button>
</div>

<script>
const CONFIG = {
  baseURL: "https://raw.githubusercontent.com/lehienbqc53-cpu/Game-solite/main/images/",
  scriptURL: "https://script.google.com/macros/s/AKfycbyIPxOrMLBfJzkaqUGtrXhxi7BlyTI3qJSEvuSvR9vChhLLUkJKFnDqv-Ki51yR4rlk2A/exec",
  timerDuration: 20
};

const ERROR_DATA = {
  sanpham: {
    errors: [
      { src: "Banh_Mau_Khong_Dat.webp", correctError: "B√°nh m√†u kh√¥ng ƒë·∫°t" },
      { src: "Banh_Khong_Dat_Bong_Khi.webp", correctError: "B√°nh kh√¥ng ƒë·∫°t b√≥ng kh√≠" },
      { src: "Banh_Vet_Nut_Khong_Dat.webp", correctError: "B√°nh v·∫øt n·ª©t kh√¥ng ƒë·∫°t" },
      { src: "Banh_co_kem_khong_Dat.webp", correctError: "B√°nh c√≥ kem kh√¥ng ƒë·∫°t" },
      { src: "Banh_vo_Khong_Dat.webp", correctError: "B√°nh v·ª° kh√¥ng ƒë·∫°t" },
      { src: "Banh_Troc_Vo_Khong_Dat.webp", correctError: "B√°nh tr√≥c v·ªè kh√¥ng ƒë·∫°t" }
    ],
    goods: ["Banh_Mau_Dat.webp","Banh_Co_Kem_Dat.webp","Banh_Troc_Vo_Dat.webp","Banh_Vo_Dat.webp","Banh_Vet_Nut_Dat.webp","Banh_Dat_Bong_Khi.webp"]
  },
  baobi1: {
    errors: [
      { src: "Duong_Han_Qua_Nhiet.webp", correctError: "ƒê∆∞·ªùng h√†n qu√° nhi·ªát" },
      { src: "Duong_Han_Yeu.webp", correctError: "ƒê∆∞·ªùng h√†n y·∫øu" },
      { src: "Duong_han_can_trang_rach.webp", correctError: "ƒê∆∞·ªùng h√†n c·∫•n tr·∫Øng r√°ch" },
      { src: "Sai_Nhoe_Date.webp", correctError: "Sai, nh√≤e date" },
      { src: "Duong_han_bung_dau_duoi_lech.webp", correctError: "ƒê∆∞·ªùng h√†n bung ƒë·∫ßu, ƒë·∫ßu l·ªách" },
      { src: "Bang_Keo_noi_cuon.webp", correctError: "BƒÉng keo n·ªëi cu·ªôn" },
      { src: "Xep_Ly_xi.webp", correctError: "X·∫øp ly x√¨" }
    ],
    goods: ["Banh_dat.webp"]
  },
  baobi2: {
    errors: [
      { src: "Sap_xep_goi_banh_khong_dat.webp", correctError: "S·∫Øp x·∫øp g√≥i b√°nh kh√¥ng ƒë·∫°t" },
      { src: "Khay_Mop_Meo_Cong_Rach.webp", correctError: "Khay m√≥p m√©o cong r√°ch" },
      { src: "Mang_Co_Nhan_Rach.webp", correctError: "M√†ng co nhƒÉn r√°ch" },
      { src: "Sai_Nhoe_date.webp", correctError: "Sai, nh√≤e date" },
      { src: "Bang_Keo_nho_5mm_khong_dat.webp", correctError: "BƒÉng keo kh√¥ng ƒë·∫°t 5cm" },
      { src: "Thung_Mop_Meo.webp", correctError: "Th√πng m√≥p m√©o" },
      { src: "Thung_Thieu_Sai_date.webp", correctError: "Th√πng thi·∫øu, sai date" },
      { src: "Sai_Thieu_date_hop.webp", correctError: "Sai, thi·∫øu date h·ªôp" },
      { src: "Hu_Hong_Duong_Mo.webp", correctError: "H∆∞ h·ªèng ƒë∆∞·ªùng m·ªü" },
      { src: "Lech_Nap_Hop.webp", correctError: "L·ªách n·∫Øp h·ªôp" },
      { src: "Nap_hop_dan_khong_dung.webp", correctError: "N·∫Øp h·ªôp d√°n kh√¥ng ƒë√∫ng" },
      { src: "Hu_hong_goc.webp", correctError: "H∆∞ h·ªèng g√≥c h·ªôp" },
      { src: "Hop_Bien_dang.webp", correctError: "H·ªôp bi·∫øn d·∫°ng" },
      { src: "Duong_han_keo_yeu_lem_keo.webp", correctError: "ƒê∆∞·ªùng h√†n keo y·∫øu, lem keo" }
    ],
    goods: ["Hop_Dat.webp"]
  }
};

const MODE_MAP = { sanpham:"S·∫£n ph·∫©m", baobi1:"Bao b√¨ c·∫•p 1", baobi2:"Bao b√¨ c·∫•p 2" };

let images=[], current=0, score=0, answered=false, timerInterval, mode="", playerName="";

function startGame(selectedMode){
  playerName=document.getElementById("playerName").value.trim();
  if(!playerName){ alert("Nh·∫≠p t√™n!"); return;}
  mode=selectedMode;
  images=[];
  ERROR_DATA[mode].errors.forEach(e=>images.push({src:e.src,isGood:false,correctError:e.correctError}));
  ERROR_DATA[mode].goods.forEach(g=>images.push({src:g,isGood:true,correctError:"ƒê·∫°t"}));
  images.sort(()=>Math.random()-0.5);
  current=0; score=0; answered=false;

  document.getElementById("menu").style.display="none";
  document.getElementById("game-container").style.display="block";
  loadErrorOptions();
  loadImage();
}

function loadErrorOptions(){
  const select=document.getElementById("errorSelect");
  select.innerHTML="<option value=''>-- Ch·ªçn l·ªói --</option>";
  ERROR_DATA[mode].errors.forEach(e=>{
    const opt=document.createElement("option");
    opt.value=e.correctError; opt.textContent=e.correctError;
    select.appendChild(opt);
  });
}

function startTimer(){
  let timeLeft=CONFIG.timerDuration;
  document.getElementById("timer").textContent="Th·ªùi gian: "+timeLeft+"s";
  timerInterval=setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").textContent="Th·ªùi gian: "+timeLeft+"s";
    if(timeLeft<=0){ clearInterval(timerInterval); answered=true; nextImage();}
  },1000);
}

function loadImage(){
  const img=images[current];
  document.getElementById("biscuitImage").src=CONFIG.baseURL+img.src;
  document.getElementById("result").textContent="";
  document.getElementById("score").textContent="ƒêi·ªÉm: "+score;
  document.getElementById("errorSection").style.display="none";
  answered=false;
  clearInterval(timerInterval); startTimer();
}

function checkAnswer(isGood){
  if(answered) return;
  const img=images[current]; clearInterval(timerInterval);
  if(img.isGood){ if(isGood){ score++; document.getElementById("result").textContent="‚úÖ ƒê√∫ng!";} 
  else {document.getElementById("result").textContent="‚ùå Sai, l√† ·∫£nh ƒë·∫°t!";} answered=true;}
  else { if(!isGood){ document.getElementById("result").textContent="Ch·ªçn lo·∫°i l·ªói"; document.getElementById("errorSection").style.display="block";}
  else {document.getElementById("result").textContent="‚ùå Sai!"; answered=true;} }
  document.getElementById("score").textContent="ƒêi·ªÉm: "+score;
}

function submitError(){
  if(answered) return;
  const selected=document.getElementById("errorSelect").value;
  const img=images[current];
  if(!selected){ document.getElementById("result").textContent="‚ö†Ô∏è Ch·ªçn lo·∫°i l·ªói!"; return;}
  if(selected===img.correctError){ score++; document.getElementById("result").textContent="‚úÖ ƒê√∫ng!";}
  else{ document.getElementById("result").textContent="‚ùå Sai! ƒê√°p √°n: "+img.correctError;}
  document.getElementById("score").textContent="ƒêi·ªÉm: "+score;
  answered=true; document.getElementById("errorSection").style.display="none";
}

function nextImage(){
  if(current<images.length-1){ current++; loadImage();}
  else{ showFinalScore();}
}

/* =========================
   Google Sheet
========================= */
async function postScore(){
  const payload={action:"save",ten_nguoi_choi:playerName,muc_choi:mode,diem:score};
  await fetch(CONFIG.scriptURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
}

async function getRanking(){
  const res=await fetch(CONFIG.scriptURL+"?action=getRanking");
  return res.json();
}

async function showFinalScore(){
  clearInterval(timerInterval);
  document.getElementById("game-container").style.display="none";
  document.getElementById("ranking-wrapper").style.display="block";
  document.getElementById("finalScoreText").textContent="ƒêi·ªÉm c·ªßa b·∫°n: "+score+"/"+images.length;
  await postScore();
  const ranking=await getRanking();
  renderRankingTable(ranking);
}

function renderRankingTable(data, filter=""){
  const table=document.getElementById("rankingTable"); let html="<tr><th>H·∫°ng</th><th>T√™n</th><th>Ch·∫ø ƒë·ªô</th><th>ƒêi·ªÉm</th></tr>";
  let rows=data; if(filter) rows=rows.filter(r=>r.muc_choi===filter);
  rows.sort((a,b)=>b.diem-a.diem); rows.slice(0,10).forEach((r,i)=>{
    const highlight=(r.ten_nguoi_choi===playerName && r.diem===score)?"highlight":"";
    html+="<tr class='"+highlight+"'><td>"+(i+1)+"</td><td>"+r.ten_nguoi_choi+"</td><td>"+r.muc_choi+"</td><td>"+r.diem+"</td></tr>";
  });
  table.innerHTML=html;
}

async function filterRanking(){
  const sel=document.getElementById("rankingFilter").value;
  const data=await getRanking();
  renderRankingTable(data,sel);
}
</script>

</body>
</html>
