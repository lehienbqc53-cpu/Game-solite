<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üè≠ LƒÉng K√≠nh Ng∆∞·ªùi Ti√™u D√πng</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
  --primary-color: #6d28d9;
  --secondary-color: #a78bfa;
  --background-gradient: linear-gradient(135deg, #fff8dc, #ffe4e6);
  --card-background: #ffffff;
  --text-color: #333333;
  --success-color: #10b981;
  --error-color: #ef4444;
  --border-radius-lg: 15px;
  --border-radius-md: 10px;
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.15);
  --highlight: #fde047;
}
body {
  font-family: 'Roboto', sans-serif;
  background: var(--background-gradient);
  text-align: center;
  margin: 0;
  padding: 20px;
  color: var(--text-color);
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  box-sizing: border-box;
}
h1 { color: var(--primary-color); font-size: 2.5em; margin-bottom: 30px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
h2 { color: var(--primary-color); margin-top: 20px; }

#menu, #game-container { background: var(--card-background); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); padding: 30px; max-width: 700px; width: 96%; margin-top: 20px; }
#menu h3 { color: var(--text-color); margin-bottom: 15px; }
input[type="text"], select {
  padding: 12px 15px;
  border: 1px solid #d1d5db;
  border-radius: var(--border-radius-md);
  width: calc(100% - 30px);
  margin-bottom: 15px;
  font-size: 1em;
  box-sizing: border-box;
  transition: border-color 0.3s ease;
}
input[type="text"]:focus, select:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.12); }

img#biscuitImage { max-width: 100%; height: auto; border-radius: var(--border-radius-md); margin-bottom: 25px; box-shadow: var(--shadow-md); background-color: #f0f0f0; min-height: 220px; object-fit: contain; }

button { padding: 12px 25px; border: none; border-radius: var(--border-radius-md); margin: 8px; background-color: var(--primary-color); color: white; font-weight: bold; font-size: 1.05em; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
button:hover { background-color: var(--secondary-color); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

button.answer-btn-good { background-color: var(--success-color); }
button.answer-btn-good:hover { background-color: #059669; }
button.answer-btn-bad { background-color: var(--error-color); }
button.answer-btn-bad:hover { background-color: #dc2626; }
button.next-btn { background-color: var(--primary-color); margin-top: 20px; }

#result { font-size: 1.2em; font-weight: bold; margin-top: 20px; min-height: 28px; }
#score, #timer { font-size: 1.1em; font-weight: bold; margin-top: 10px; }
#score { color: var(--success-color); }
#timer { color: var(--error-color); margin-bottom: 10px; }

#ranking-wrapper { display: none; margin-top: 20px; max-width: 700px; width: 96%; }
#ranking-table-wrap { margin-top:12px; }
table { width: 100%; border-collapse: collapse; margin-top: 18px; border-radius: var(--border-radius-md); overflow: hidden; box-shadow: var(--shadow-md); }
th, td { border: 1px solid #e5e7eb; padding: 12px 10px; font-size: 0.95em; text-align: left; }
th { background: var(--primary-color); color: white; font-weight: bold; text-transform: uppercase; }
tr:nth-child(even) { background-color: #f9fafb; }
tr:hover { background-color: #f3f4f6; }
.highlight { background-color: var(--highlight) !important; }
</style>
</head>
<body>

<h1>üè≠ LƒÉng K√≠nh Ng∆∞·ªùi Ti√™u D√πng</h1>

<div id="menu">
  <h3>Nh·∫≠p t√™n c·ªßa b·∫°n:</h3>
  <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
  <h2>Ch·ªçn ch·∫ø ƒë·ªô ch∆°i:</h2>
  <button onclick="startGame('sanpham')"><i class="fas fa-cookie-bite"></i> S·∫£n ph·∫©m</button>
  <button onclick="startGame('baobi1')"><i class="fas fa-box"></i> Bao b√¨ c·∫•p 1</button>
  <button onclick="startGame('baobi2')"><i class="fas fa-boxes"></i> Bao b√¨ c·∫•p 2</button>
</div>

<div id="game-container" style="display:none;">
  <div id="timer">Th·ªùi gian: 20s</div>
  <img id="biscuitImage" src="" alt="·∫¢nh l·ªói QC">
  <div>
    <button class="answer-btn-good" onclick="checkAnswer(true)">ƒê·∫°t</button>
    <button class="answer-btn-bad" onclick="checkAnswer(false)">L·ªói</button>
  </div>
  <div id="result"></div>
  <div id="score">ƒêi·ªÉm: 0</div>
  <br>
  <button class="next-btn" onclick="nextImage()">·∫¢nh ti·∫øp theo</button>
</div>

<div id="ranking-wrapper">
  <h2>üéâ Ho√†n th√†nh!</h2>
  <p id="finalScoreText"></p>
  <label for="rankingFilter">L·ªçc m·ª•c ch∆°i:</label>
  <select id="rankingFilter" onchange="filterRanking()">
    <option value="">T·∫•t c·∫£</option>
    <option value="sanpham">S·∫£n ph·∫©m</option>
    <option value="baobi1">Bao b√¨ c·∫•p 1</option>
    <option value="baobi2">Bao b√¨ c·∫•p 2</option>
  </select>
  <div id="ranking-table-wrap">
    <table id="rankingTable"></table>
  </div>
  <br>
  <button onclick="location.reload()">Ch∆°i l·∫°i</button>
</div>

<script>
const CONFIG = {
  baseURL: "https://raw.githubusercontent.com/lehienbqc53-cpu/Game-solite/main/images/",
  scriptURL: "https://script.google.com/macros/s/AKfycbxM0RR2s0EvpBWXT3sM1occ8qwrSJNTLb7jJcUHYYCUECbg6qrKscer9UptXwY9DEZd8g/exec",
  timerDuration: 20
};

// D·ªØ li·ªáu ƒë∆°n gi·∫£n ƒë·ªÉ demo
const ERROR_DATA = {
  sanpham: { errors:[{src:"Banh_Khong_Dat_Bong_Khi.webp", correctError:"B√°nh kh√¥ng ƒë·∫°t b√≥ng kh√≠"}], goods:["Banh_Dat_Bong_Khi.webp"] },
  baobi1: { errors:[{src:"Duong_Han_Qua_Nhiet.webp", correctError:"ƒê∆∞·ªùng h√†n qu√° nhi·ªát"}], goods:["Banh_dat.webp"] },
  baobi2: { errors:[{src:"Sap_xep_goi_banh_khong_dat.webp", correctError:"S·∫Øp x·∫øp g√≥i b√°nh kh√¥ng ƒë·∫°t"}], goods:["Hop_Dat.webp"] }
};

const MODE_MAP = { sanpham:"S·∫£n ph·∫©m", baobi1:"Bao b√¨ c·∫•p 1", baobi2:"Bao b√¨ c·∫•p 2" };
const REVERSE_MODE_MAP = Object.entries(MODE_MAP).reduce((acc,[k,v])=>{ acc[v]=k; return acc; }, {});

class QCGame {
  constructor() {
    this.images = [];
    this.mode = "";
    this.current = 0;
    this.score = 0;
    this.playerName = "";
    this.answered = false;
    this.timeLeft = CONFIG.timerDuration;
    this.timerInterval = null;
    this.dom = {
      menu: document.getElementById("menu"),
      gameContainer: document.getElementById("game-container"),
      playerNameInput: document.getElementById("playerName"),
      timerElement: document.getElementById("timer"),
      imgElement: document.getElementById("biscuitImage"),
      resultElement: document.getElementById("result"),
      scoreElement: document.getElementById("score"),
      rankingWrapper: document.getElementById("ranking-wrapper"),
      finalScoreText: document.getElementById("finalScoreText"),
      rankingTable: document.getElementById("rankingTable"),
      rankingFilter: document.getElementById("rankingFilter")
    };
    window.startGame = this.startGame.bind(this);
    window.checkAnswer = this.checkAnswer.bind(this);
    window.nextImage = this.nextImage.bind(this);
    window.filterRanking = this.filterRanking.bind(this);
  }

  shuffleArray(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } }

  loadGameData(mode){
    let all = [];
    ERROR_DATA[mode].errors.forEach(e=>all.push({src:CONFIG.baseURL+e.src,isGood:false,correctError:e.correctError}));
    ERROR_DATA[mode].goods.forEach(g=>all.push({src:CONFIG.baseURL+g,isGood:true,correctError:"ƒê·∫°t"}));
    this.shuffleArray(all); return all;
  }

  startGame(mode){
    this.playerName=this.dom.playerNameInput.value.trim();
    if(!this.playerName){ alert("Nh·∫≠p t√™n!"); return; }
    this.mode=mode;
    this.images=this.loadGameData(mode);
    this.current=0; this.score=0; this.answered=false;
    this.dom.menu.style.display="none";
    this.dom.gameContainer.style.display="block";
    this.loadImage();
    this.dom.rankingWrapper.style.display="none";
  }

  startTimer(){ this.timeLeft=CONFIG.timerDuration; this.dom.timerElement.textContent=`Th·ªùi gian: ${this.timeLeft}s`;
    this.timerInterval=setInterval(()=>{ this.timeLeft--; this.dom.timerElement.textContent=`Th·ªùi gian: ${this.timeLeft}s`; if(this.timeLeft<=0){ clearInterval(this.timerInterval); this.answered=true; this.nextImage(); } },1000); 
  }

  checkAnswer(isGood){ if(this.answered) return; const cur=this.images[this.current]; clearInterval(this.timerInterval);
    if((isGood && cur.isGood) || (!isGood && !cur.isGood)){ this.score++; this.dom.scoreElement.textContent="ƒêi·ªÉm: "+this.score; } this.answered=true; this.nextImage();
  }

  nextImage(){ if(this.current<this.images.length-1){ this.current++; this.loadImage(); } else{ this.showFinalScore(); } }

  loadImage(){ const cur=this.images[this.current]; this.dom.imgElement.src=cur.src; this.answered=false; clearInterval(this.timerInterval); this.startTimer(); }

  async postScore(){
    const payload={action:"save",ten_nguoi_choi:this.playerName,muc_choi:this.mode,diem:this.score};
    await fetch(CONFIG.scriptURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  }

  async getRanking(){ const res=await fetch(CONFIG.scriptURL+"?action=getRanking"); return res.json(); }

  normalizeModeValue(val){ if(!val && val!==0) return ""; const str=String(val).trim(); if(MODE_MAP[str]) return str; if(REVERSE_MODE_MAP[str]) return REVERSE_MODE_MAP[str]; return str; }

  renderRankingTable(arr,filterKey=""){ let rows=""; arr.slice(0,50).forEach((r,i)=>{ const name=r.name??""; const modeKey=this.normalizeModeValue(r.mode); const score=r.score??0; if(filterKey && filterKey!==modeKey) return; rows+=`<tr${(name===this.playerName&&score===this.score)?" class='highlight'":""}><td>${i+1}</td><td>${name}</td><td>${MODE_MAP[modeKey]??modeKey}</td><td>${score}</td></tr>`; }); this.dom.rankingTable.innerHTML="<tr><th>H·∫°ng</th><th>T√™n</th><th>M·ª•c ch∆°i</th><th>ƒêi·ªÉm</th></tr>"+rows; }

  async showFinalScore(){
    clearInterval(this.timerInterval);
    this.dom.gameContainer.style.display="none";
    this.dom.rankingWrapper.style.display="block";
    this.dom.finalScoreText.textContent=`ƒêi·ªÉm c·ªßa b·∫°n: ${this.score}/${this.images.length}`;
    try{ await this.postScore(); }catch(err){ console.warn(err); }
    try{ const ranking=await this.getRanking(); this.renderRankingTable(ranking,""); }catch(err){ console.error(err); this.dom.rankingTable.innerHTML="<tr><td colspan='4'>Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng</td></tr>"; }
  }

  async filterRanking(){ const sel=this.dom.rankingFilter.value; try{ const ranking=await this.getRanking(); this.renderRankingTable(ranking,sel); }catch(err){ console.error(err); } }
}

document.addEventListener("DOMContentLoaded",()=>{ window.qcGame=new QCGame(); });
function startGame(mode){ window.qcGame.startGame(mode); }
function checkAnswer(isGood){ window.qcGame.checkAnswer(isGood); }
function nextImage(){ window.qcGame.nextImage(); }
function filterRanking(){ window.qcGame.filterRanking(); }
</script>

</body>
</html>
